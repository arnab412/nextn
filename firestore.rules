/**
 * This ruleset allows any authenticated user to perform all data operations.
 * The concept of an 'admin' role has been removed for simplicity.
 *
 * Core Philosophy:
 * If a user is signed in, they have full access to create, read, update, and delete data.
 * This is a less secure, but simpler model suitable for single-user or trusted-group applications.
 *
 * Data Structure:
 * - /students: Information about students.
 * - /incomes: Financial records of fees collected.
 * - /expenses: Records of office expenses.
 * - /daily_registers: Daily financial reconciliation reports.
 *
 * Key Security Decisions:
 * - Authenticated Access Only: All collections require the user to be signed in. There is no public access.
 * - Full CRUD for Authenticated Users: Any signed-in user can manage all data across all primary collections.
 * - Accountability: The 'incomes' collection still logs which user created a record via the `collectedBy` field.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if a document exists. Used for safe updates/deletes.
     */
    function docExists() {
        return resource != null;
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    /**
     * @description Manages student records. Any signed-in user can manage student information.
     * @path /students/{studentId}
     */
    match /students/{studentId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Manages income records. Any signed-in user can manage this data.
     * @path /incomes/{incomeId}
     */
    match /incomes/{incomeId} {
      allow read, write: if isSignedIn();
      // On create, still recommend ensuring the user logs themselves as the collector.
      allow create: if isSignedIn() && request.resource.data.collectedBy == request.auth.uid;
    }

    /**
     * @description Manages expense records. Any signed-in user can manage expenses.
     * @path /expenses/{expenseId}
     */
    match /expenses/{expenseId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Manages daily cash registers. Any signed-in user can manage registers.
     * @path /daily_registers/{registerId}
     */
    match /daily_registers/{registerId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Manages admin roles.
     * @path /admins/{email}
     */
    match /admins/{email} {
      allow read, write: if isSignedIn();
    }

    // The roles_admin collection is no longer needed with this simplified ruleset.
    // If you re-introduce roles, you would add rules for /roles_admin/{userId} here.
  }
}
